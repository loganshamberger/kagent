# KAGENT MBSE (Model-Based Systems Engineering) Diagrams

This document contains comprehensive MBSE diagrams for the kagent system architecture.

## 1. System Context Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           KAGENT SYSTEM                                 │
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │   Web UI     │  │   CLI Tool   │  │  REST API    │  │  A2A Proto │ │
│  │  (Next.js)   │  │    (Go)      │  │  (HTTP/REST) │  │ (A2A 0.3)  │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └─────┬──────┘ │
│         │                 │                 │                 │        │
│         └─────────────────┼─────────────────┼─────────────────┘        │
│                           │                 │                          │
└───────────────────────────┼─────────────────┼──────────────────────────┘
                            │                 │
         ┌──────────────────┴─────────────────┴──────────────────┐
         │                                                       │
         ▼                                                       ▼
┌─────────────────────────────────┐              ┌────────────────────────┐
│   Kubernetes API Server         │              │  External Services     │
│   ─────────────────────────     │              │  ────────────────────  │
│  - Custom Resource Apis         │              │  - LLM Providers       │
│  - Core v1 APIs                 │              │    (OpenAI/Anthropic)  │
│  - Apps APIs                    │              │  - MCP Tool Servers    │
│  - RBAC APIs                    │              │  - Vector DB (Pinecone)│
└──────────┬──────────────────────┘              │  - OCI Registries      │
           │                                     └────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    Kubernetes Cluster                                   │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ Control Plane Components                                           │ │
│  │  - Agent Controller                                                │ │
│  │  - ModelConfig Controller                                          │ │
│  │  - RemoteMCPServer Controller                                      │ │
│  │  - AgentRegistry Controller                                        │ │
│  │  - HTTP Server & A2A Handler                                       │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ Data Plane Components                                              │ │
│  │  - Agent Deployment Pods (Python ADK Runtime)                      │ │
│  │  - Database (SQLite/PostgreSQL)                                    │ │
│  │  - ConfigMaps, Secrets, Services                                   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. CRD Type Hierarchy & Relationships

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        CRD RELATIONSHIPS                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│     ┌──────────────────┐                                                 │
│     │  AgentRegistry   │  (cluster-scoped)                               │
│     │  ────────────────│                                                 │
│     │  - selector      │                                                 │
│     │  - discovery     │                                                 │
│     │  - phase         │                                                 │
│     └────────┬─────────┘                                                 │
│              │ creates/owns (server-side apply)                          │
│              ▼                                                            │
│     ┌──────────────────┐                                                 │
│     │   AgentCard      │                                                 │
│     │  ────────────────│                                                 │
│     │  - sourceRef     │                                                 │
│     │  - endpoints     │                                                 │
│     │  - publicCard    │                                                 │
│     │  - capabilities  │                                                 │
│     └──────────────────┘                                                 │
│              ▲                                                            │
│              │ references                                                 │
│              │                                                            │
│     ┌────────┴──────────────┐                                             │
│     │                       │                                             │
│     ▼                       ▼                                             │
│ ┌─────────┐            ┌──────────────────┐                              │
│ │ Agent   │            │  Deployment      │                              │
│ │         │            │  (external)      │                              │
│ └────┬────┘            └──────────────────┘                              │
│      │                                                                    │
│      │ references (same namespace)                                       │
│      │                                                                    │
│      ├─────────────────┬──────────────────┐                              │
│      │                 │                  │                              │
│      ▼                 ▼                  ▼                              │
│ ┌──────────────┐ ┌────────────────┐ ┌──────────────────┐                │
│ │ ModelConfig  │ │ RemoteMCPServer│ │  ToolServer      │                │
│ │ ────────────│ │ ───────────────│ │ ─────────────────│                │
│ │ - provider   │ │ - protocol     │ │ - description    │                │
│ │ - model      │ │ - url          │ │ - config         │                │
│ │ - apiKeyRef  │ │ - headers      │ │   (stdio/sse/http)               │
│ └──────┬───────┘ └────────────────┘ └──────────────────┘                │
│        │                                                                  │
│        │ references                                                       │
│        ▼                                                                  │
│ ┌──────────────┐                                                          │
│ │  Secret      │  (API keys, credentials)                                │
│ │  ConfigMap   │  (tool configs, headers)                                │
│ └──────────────┘                                                          │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 3. Component Interaction Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    CONTROL PLANE INTERACTIONS                            │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                  Kubernetes Control Plane                          │  │
│  │  ┌──────────────────────────────────────────────────────────────┐  │  │
│  │  │            Controller Manager (manager.go)                   │  │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌────────────────────┐  │  │  │
│  │  │  │ Agent        │  │ ModelConfig  │  │ RemoteMCPServer   │  │  │  │
│  │  │  │ Controller   │  │ Controller   │  │ Controller        │  │  │  │
│  │  │  └─────┬────────┘  └─────┬────────┘  └─────┬─────────────┘  │  │  │
│  │  │        │                 │                 │                 │  │  │
│  │  │        └─────────────────┼─────────────────┘                 │  │  │
│  │  │                          │                                   │  │  │
│  │  │  ┌────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │  AgentRegistry Controller                             │  │  │  │
│  │  │  │  - Discovers agents with annotation                   │  │  │  │
│  │  │  │  - Creates AgentCards (SSA)                           │  │  │  │
│  │  │  │  - Health checks endpoints                            │  │  │  │
│  │  │  └────────┬───────────────────────────────────────────────┘  │  │  │
│  │  │           │                                                  │  │  │
│  │  │  ┌────────▼────────────────────────────────────────────────┐ │  │  │
│  │  │  │     KAgentReconciler (Unified Reconciliation)           │ │  │  │
│  │  │  │  - Translates CRDs to K8s resources                     │ │  │  │
│  │  │  │  - Manages Deployments, Services, ConfigMaps            │ │  │  │
│  │  │  │  - Syncs with Database                                  │ │  │  │
│  │  │  │  - Registers A2A handlers                               │ │  │  │
│  │  │  └────────┬───────────────────────────────────────────────┘  │  │  │
│  │  │           │                                                  │  │  │
│  │  │  ┌────────▼────────────────────────────────────────────────┐ │  │  │
│  │  │  │           Kubernetes API Client (k8s.io/client-go)      │ │  │  │
│  │  │  └────────────────────────────────────────────────────────┘  │  │  │
│  │  └──────────────────────────────────────────────────────────────┘  │  │
│  │                          │                                         │  │
│  │                          ▼                                         │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │             HTTP Server (internal/httpserver)                │ │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐   │ │  │
│  │  │  │  REST API    │  │  A2A Mux     │  │  Auth Middleware │   │ │  │
│  │  │  │  Handlers    │  │  Handler     │  │                  │   │ │  │
│  │  │  │  ──────────  │  │  ──────────  │  │  ──────────────  │   │ │  │
│  │  │  │  /agents     │  │  /a2a/:ns/:  │  │  - JWT auth      │   │ │  │
│  │  │  │  /sessions   │  │    name      │  │  - RBAC checks   │   │ │  │
│  │  │  │  /tasks      │  │              │  │                  │   │ │  │
│  │  │  │  /feedback   │  │              │  │                  │   │ │  │
│  │  │  └──────────────┘  └──────┬───────┘  └──────────────────┘   │ │  │
│  │  │                           │                                   │ │  │
│  │  │                    ┌──────▼──────┐                           │ │  │
│  │  │                    │ A2AHandlerMux│                           │ │  │
│  │  │                    │ - Routes to   │                          │ │  │
│  │  │                    │   agents      │                          │ │  │
│  │  │                    └──────┬────────┘                          │ │  │
│  │  │                           │                                   │ │  │
│  │  │                           ▼                                   │ │  │
│  │  │                  ┌──────────────────┐                         │ │  │
│  │  │                  │ Agent A2A Client │                         │ │  │
│  │  │                  │ (passthrough)    │                         │ │  │
│  │  │                  └──────────────────┘                         │ │  │
│  │  │                           │                                   │ │  │
│  │  │                    ┌──────▼──────┐                           │ │  │
│  │  │                    │  DB Client  │                           │ │  │
│  │  │                    │  (GORM)     │                           │ │  │
│  │  │                    └─────────────┘                           │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
```

## 4. Data Flow: Agent Lifecycle

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      AGENT LIFECYCLE DATA FLOW                           │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. CREATE AGENT                                                         │
│     ┌────────────┐      ┌────────────┐      ┌──────────────────┐        │
│     │ User/API   │─────►│ Agent CRD  │─────►│ Agent Controller │        │
│     │ Client     │      │ (kubectl)  │      │  (reconcile)     │        │
│     └────────────┘      └────────────┘      └────────┬─────────┘        │
│                                                      │                   │
│  2. TRANSLATE TO K8s RESOURCES                      │                   │
│                                                      ▼                   │
│                         ┌────────────────────────────────────────────┐  │
│                         │  ADK Translator                            │  │
│                         │  - Parses Agent spec                       │  │
│                         │  - Validates references                   │  │
│                         │  - Creates K8s resources                  │  │
│                         └────────────────┬───────────────────────────┘  │
│                                          │                              │
│                    ┌─────────────────────┼─────────────────────┐        │
│                    │                     │                     │        │
│                    ▼                     ▼                     ▼        │
│            ┌─────────────┐       ┌──────────────┐      ┌────────────┐ │
│            │  ConfigMap  │       │  Deployment  │      │  Service   │ │
│            │  (agent cfg)│       │  (agent pod) │      │ (A2A URL)  │ │
│            └─────────────┘       └──────────────┘      └────────────┘ │
│                    │                     │                     │       │
│  3. REGISTER A2A HANDLER                 │                     │       │
│                    │                     │                     │       │
│                    └─────────────────────┼─────────────────────┘       │
│                                          │                              │
│                                          ▼                              │
│                    ┌────────────────────────────────────────────┐      │
│                    │  A2A Reconciler                            │      │
│                    │  - Waits for pod to be ready               │      │
│                    │  - Creates A2A client                      │      │
│                    │  - Registers in A2AHandlerMux              │      │
│                    │  - Exposes /api/a2a/{ns}/{name}            │      │
│                    └────────────┬───────────────────────────────┘      │
│                                 │                                      │
│  4. AUTO-DISCOVERY (optional)  │                                      │
│                                 ▼                                      │
│                    ┌────────────────────────────────────────────┐      │
│                    │  AgentRegistry Controller                  │      │
│                    │  - Finds agents with annotation            │      │
│                    │  - Creates AgentCard (SSA)                │      │
│                    │  - Health checks endpoints                 │      │
│                    │  - Publishes to ConfigMap                  │      │
│                    └────────────────────────────────────────────┘      │
│                                                                          │
│  5. READY FOR REQUESTS                                                  │
│     ┌────────────┐      ┌──────────────────┐                            │
│     │ User/UI    │─────►│ POST /a2a/:ns/:  │                            │
│     │            │      │ name              │                            │
│     └────────────┘      └─────────┬────────┘                            │
│                                   │                                      │
│                                   ▼                                      │
│                    ┌────────────────────────────────────────────┐       │
│                    │  HTTP Server                               │       │
│                    │  - Routes to A2A Mux                       │       │
│                    │  - Creates session/events in DB            │       │
│                    │  - Returns SSE stream                      │       │
│                    └────────────┬───────────────────────────────┘       │
│                                 │                                       │
│                                 ▼                                       │
│                    ┌────────────────────────────────────────────┐       │
│                    │  Agent Pod (A2A Server)                    │       │
│                    │  - Receives A2A message                    │       │
│                    │  - Executes with ADK                       │       │
│                    │  - Calls LLM APIs                          │       │
│                    │  - Reports results                         │       │
│                    └────────────────────────────────────────────┘       │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 5. Message Flow: A2A Protocol

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         A2A MESSAGE FLOW                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Time │ Client              │ Controller       │ Agent Pod             │
│  ─────┼────────────────────┼──────────────────┼──────────────────────┤
│   t0  │                    │                  │                      │
│       │ POST /a2a/ns1/ag1  │                  │                      │
│       │ {message}          │                  │                      │
│       ├───────────────────►│                  │                      │
│       │                    │                  │                      │
│   t1  │                    │ Look up handler  │                      │
│       │                    │ in A2AHandlerMux │                      │
│       │                    │                  │                      │
│   t2  │                    │ Create A2A req   │                      │
│       │                    ├─────────────────►│                      │
│       │                    │  A2A Message    │                      │
│       │                    │  (0.3.0 format)  │                      │
│       │                    │                  │                      │
│   t3  │                    │                  │ Parse message        │
│       │                    │                  │ Get model from ref   │
│       │                    │                  │ Load tools list      │
│       │                    │                  │                      │
│   t4  │                    │                  │ Call LLM API        │
│       │                    │                  ├──────────┐           │
│       │                    │                  │ OpenAI   │           │
│       │                    │                  │ /v1/chat │           │
│       │                    │                  │ /completion(stream)  │
│       │                    │                  │           ▼          │
│       │                    │                  │ Tokens...           │
│       │                    │                  │           ◄──────────┤
│       │                    │                  │                      │
│   t5  │                    │ SSE: TaskStatus  │                      │
│       │◄───────────────────┤◄─────────────────┤                      │
│       │ event:             │                  │                      │
│       │ TaskStatus         │                  │                      │
│       │ {status:"running"} │                  │                      │
│       │                    │                  │                      │
│   t6  │                    │ SSE: Artifact    │                      │
│       │◄───────────────────┤◄─────────────────┤                      │
│       │ event: Artifact    │                  │                      │
│       │ {text:"The ..."}   │                  │                      │
│       │                    │                  │                      │
│   t7  │                    │ SSE: TaskStatus  │                      │
│       │◄───────────────────┤◄─────────────────┤                      │
│       │ event: TaskStatus  │                  │                      │
│       │ {status:"complete"}│                  │                      │
│       │                    │                  │                      │
│   t8  │ SSE stream closed  │                  │                      │
│       │                    │                  │                      │
│                                                                          │
│  Stored in Database:                                                     │
│  - Session {id, user_id, agent_id}                                       │
│  - Events {id, session_id, data (JSON)}                                  │
│  - Can be retrieved via GET /api/sessions/:id/events                     │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 6. Tool Discovery Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    TOOL DISCOVERY DATA FLOW                              │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. CREATE REMOTE MCP SERVER                                             │
│     ┌────────────────────┐                                               │
│     │ RemoteMCPServer CRD│                                               │
│     │  ─────────────────│                                                │
│     │  url: https://...  │                                               │
│     │  protocol: SSE     │                                               │
│     │  headers: ...      │                                               │
│     └─────────┬──────────┘                                               │
│               │                                                           │
│  2. DISCOVERY                                                            │
│               ▼                                                           │
│     ┌────────────────────────────────────────┐                           │
│     │ RemoteMCPServer Controller             │                           │
│     │  - Establish connection to MCP server  │                           │
│     │  - Call /tools/list endpoint           │                           │
│     │  - Parse tool definitions              │                           │
│     │  - Update status.discoveredTools       │                           │
│     └────────┬─────────────────────────────┘                           │
│              │                                                           │
│  3. STORAGE                                                              │
│              ▼                                                           │
│     ┌────────────────────────────────────────┐                           │
│     │ CRD Status & Database                  │                           │
│     │  - status.discoveredTools[]            │                           │
│     │  - Database Tool table                 │                           │
│     │    (name, schema, description)         │                           │
│     └────────┬─────────────────────────────┘                           │
│              │                                                           │
│  4. RETRIEVAL                                                            │
│              ▼                                                           │
│     ┌────────────────────────────────────────┐                           │
│     │ HTTP REST API                          │                           │
│     │  GET /api/toolservers/:name/tools      │                           │
│     │  Returns: [{name, schema, desc, ...}]  │                           │
│     └────────────────────────────────────────┘                           │
│              ▲                                                            │
│              │                                                            │
│              │ consumed by                                               │
│              │                                                            │
│     ┌────────────────────────────────────────┐                           │
│     │ Agent Tool Selection                   │                           │
│     │ - UI shows available tools              │                           │
│     │ - Agent config references tools         │                           │
│     │ - At runtime: LLM can call tools       │                           │
│     └────────────────────────────────────────┘                           │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 7. Database Schema (Entity-Relationship)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                       DATABASE ENTITIES                                  │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────┐                                     │
│  │         Session                 │                                     │
│  │  ───────────────────────────    │                                     │
│  │  PK: id                         │                                     │
│  │     user_id (FK)               │◄────────────┐                       │
│  │     agent_id                    │             │                       │
│  │     namespace                   │             │                       │
│  │     name                        │             │                       │
│  │     created_at                  │             │                       │
│  │     updated_at                  │             │                       │
│  └─────────┬───────────────────────┘             │                       │
│            │                                     │                       │
│            │ 1..* (has)                          │ 1..1                  │
│            │                                     │                       │
│            ▼                                     │                       │
│  ┌─────────────────────────────────┐             │                       │
│  │         Event                   │             │                       │
│  │  ───────────────────────────    │             │                       │
│  │  PK: id                         │             │                       │
│  │     session_id (FK) ────────────┼─────────────┘                       │
│  │     user_id (FK)               │                                     │
│  │     type (TaskStatus/Artifact) │                                     │
│  │     data (JSON)                │                                     │
│  │     created_at                 │                                     │
│  └─────────────────────────────────┘                                     │
│                                                                          │
│  ┌─────────────────────────────────┐                                     │
│  │         Task                    │                                     │
│  │  ───────────────────────────    │                                     │
│  │  PK: id                         │                                     │
│  │     session_id (FK)            │                                     │
│  │     name                        │                                     │
│  │     data (JSON)                │                                     │
│  │     status                      │                                     │
│  │     created_at                 │                                     │
│  └─────────────────────────────────┘                                     │
│                                                                          │
│  ┌─────────────────────────────────┐                                     │
│  │         Tool                    │                                     │
│  │  ───────────────────────────    │                                     │
│  │  PK: id                         │                                     │
│  │     name                        │                                     │
│  │     server_id (FK) ──────────┐  │                                     │
│  │     schema (JSON)            │  │                                     │
│  │     description              │  │                                     │
│  │     discovered_at            │  │                                     │
│  └─────────────────────────────┬┘  │                                     │
│                                 │   │                                     │
│                                 │   │                                     │
│  ┌─────────────────────────────┴──────────────┐                          │
│  │         ToolServer                         │                          │
│  │  ───────────────────────────────────────   │                          │
│  │  PK: id                                    │                          │
│  │     name                                   │                          │
│  │     type (RemoteMCP/Stdio/Agent)           │                          │
│  │     endpoint                               │                          │
│  │     created_at                             │                          │
│  └────────────────────────────────────────────┘                          │
│                                                                          │
│  ┌──────────────────────────────────┐                                    │
│  │       Feedback                   │                                    │
│  │  ──────────────────────────────  │                                    │
│  │  PK: id                          │                                    │
│  │     user_id (FK)                │                                    │
│  │     session_id (FK)             │                                    │
│  │     rating                       │                                    │
│  │     comment                      │                                    │
│  │     created_at                   │                                    │
│  └──────────────────────────────────┘                                    │
│                                                                          │
│  ┌──────────────────────────────────┐                                    │
│  │   LangGraphCheckpoint            │                                    │
│  │  ──────────────────────────────  │                                    │
│  │  PK: id                          │                                    │
│  │     thread_id                    │                                    │
│  │     checkpoint_id                │                                    │
│  │     data (JSON)                  │                                    │
│  │     created_at                   │                                    │
│  └──────────────────────────────────┘                                    │
│                                                                          │
│  ┌──────────────────────────────────┐                                    │
│  │  CrewAIAgentMemory               │                                    │
│  │  ──────────────────────────────  │                                    │
│  │  PK: id                          │                                    │
│  │     agent_id                     │                                    │
│  │     memory (JSON)                │                                    │
│  │     updated_at                   │                                    │
│  └──────────────────────────────────┘                                    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 8. State Machine: Agent Lifecycle

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    AGENT STATE TRANSITIONS                               │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                      ┌──────────────────┐                                │
│                      │    Pending       │  (Initial State)               │
│                      │  (CRD created)   │                                │
│                      └────────┬─────────┘                                │
│                               │                                          │
│                  (Controller validates)                                  │
│                               │                                          │
│                               ▼                                          │
│                      ┌──────────────────┐                                │
│                      │   Accepted       │                                │
│                      │  (Conditions OK) │                                │
│                      └────────┬─────────┘                                │
│                               │                                          │
│          (Deployment created & pod running)                              │
│                               │                                          │
│                               ▼                                          │
│                      ┌──────────────────┐                                │
│                      │     Ready        │  (Serving requests)            │
│                      │  (Pod running)   │                                │
│                      └────────┬─────────┘                                │
│                               │                                          │
│       ┌─ (Config changed) ────┴─ (Pod crashed) ─┐                      │
│       │                                          │                       │
│       ▼                                          ▼                       │
│  ┌──────────┐                            ┌────────────┐                  │
│  │ Updating │                            │   Failing  │                  │
│  │          │                            │            │                  │
│  └────┬─────┘                            └────┬──────┘                  │
│       │                                       │                          │
│       │                                  (Retry logic)                   │
│       │                                       │                          │
│       └───────────────┬──────────────────────┘                          │
│                       │                                                  │
│                       ▼                                                  │
│              ┌─────────────────┐                                         │
│              │     Ready       │  (Recovered)                            │
│              └─────────────────┘                                         │
│                                                                          │
│  Possible Final States:                                                  │
│    - Ready (serving)                                                     │
│    - Failing (needs intervention)                                        │
│    - Terminating (being deleted)                                         │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 9. Deployment Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                  KUBERNETES DEPLOYMENT STRUCTURE                         │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                  kagent Namespace                                │   │
│  │                                                                  │   │
│  │  ┌──────────────────────────────────────────────────────────┐  │   │
│  │  │        Control Plane Deployment                          │  │   │
│  │  │  (controller + httpserver in single pod)                │  │   │
│  │  │  ┌────────────────────────────────────────────────────┐ │  │   │
│  │  │  │  Pod: kagent-manager-xxx                           │ │  │   │
│  │  │  │  ┌──────────────┐        ┌──────────────────────┐  │ │  │   │
│  │  │  │  │  Controller  │        │  HTTP Server        │  │ │  │   │
│  │  │  │  │  Manager     │        │  (FastAPI/Go)       │  │ │  │   │
│  │  │  │  │ (reconcilers)│        │  :8083              │  │ │  │   │
│  │  │  │  └──────────────┘        └──────────────────────┘  │ │  │   │
│  │  │  │         │                           │               │ │  │   │
│  │  │  │         └───────────────────────────┘               │ │  │   │
│  │  │  │                  │                                  │ │  │   │
│  │  │  │         ┌────────▼────────┐                         │ │  │   │
│  │  │  │         │  DB Client      │                         │ │  │   │
│  │  │  │         │  (K8s ConfigMap)│                         │ │  │   │
│  │  │  │         └─────────────────┘                         │ │  │   │
│  │  │  └────────────────────────────────────────────────────┘ │  │   │
│  │  └──────────────────────────────────────────────────────────┘  │   │
│  │                          │                                      │   │
│  │  ┌──────────────────────┴──────────────────────────────────┐  │   │
│  │  │    Agent Namespaces (agent-ns-1, agent-ns-2, ...)       │  │   │
│  │  │                                                          │  │   │
│  │  │  ┌──────────────────────────────────────────────────┐  │  │   │
│  │  │  │  Agent-1 (Deployment)                            │  │  │   │
│  │  │  │  ┌────────────────────────────────────────────┐ │  │  │   │
│  │  │  │  │ Pod: agent-1-5d8f7xxxxx                     │ │  │  │   │
│  │  │  │  │ ┌──────────────────────────────────────┐   │ │  │  │   │
│  │  │  │  │ │ Container: agent (Python/FastAPI)   │   │ │  │  │   │
│  │  │  │  │ │ - A2A Server                         │   │ │  │  │   │
│  │  │  │  │ │ - ADK Runner                         │   │ │  │  │   │
│  │  │  │  │ │ - LLM Client                         │   │ │  │  │   │
│  │  │  │  │ └──────────────────────────────────────┘   │ │  │  │   │
│  │  │  │  └────────────────────────────────────────────┘ │  │  │   │
│  │  │  │       ▲                        ▲                 │  │  │   │
│  │  │  │       │ (Service: agent-1)     │ (ConfigMap)     │  │  │   │
│  │  │  │       │                        │                 │  │  │   │
│  │  │  │       └─────────────┬──────────┘                 │  │  │   │
│  │  │  │                     │                            │  │  │   │
│  │  │  │           ┌─────────▼────────┐                  │  │  │   │
│  │  │  │           │ Endpoint: :8000  │                  │  │  │   │
│  │  │  │           │ /a2a/*           │                  │  │  │   │
│  │  │  │           └──────────────────┘                  │  │  │   │
│  │  │  └──────────────────────────────────────────────────┘  │  │   │
│  │  │                                                          │  │   │
│  │  │  ┌──────────────────────────────────────────────────┐  │  │   │
│  │  │  │  Agent-N (Deployment)                            │  │  │   │
│  │  │  │  [Same structure as Agent-1]                     │  │  │   │
│  │  │  └──────────────────────────────────────────────────┘  │  │   │
│  │  │                                                          │  │   │
│  │  └──────────────────────────────────────────────────────────┘  │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  Storage:                                                                │
│    - PersistentVolume: database (SQLite or mounted PG)                  │
│    - Secrets: API keys, credentials                                     │
│    - ConfigMaps: Agent configs, tool definitions                        │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 10. Constraints & Non-Functional Requirements

```
┌──────────────────────────────────────────────────────────────────────────┐
│             SYSTEM CONSTRAINTS & REQUIREMENTS                            │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ SCALABILITY:                                                             │
│   - Horizontal: Multiple agent pods (Deployment replicas)               │
│   - Vertical: CPU/memory limits per component                           │
│   - Database: SQLite for single-node, PostgreSQL for multi-node        │
│                                                                          │
│ RELIABILITY:                                                             │
│   - Health checks: Readiness/Liveness probes on pods                    │
│   - Retry logic: Exponential backoff for transient failures              │
│   - State persistence: All events stored in database                     │
│   - Idempotency: A2A messages can be safely retried                     │
│                                                                          │
│ SECURITY:                                                                │
│   - Secrets management: API keys in K8s Secrets                          │
│   - RBAC: Least privilege for service accounts                          │
│   - Network policies: Restrict inter-pod communication                   │
│   - TLS: Controller/Agent communication can be encrypted                │
│   - Authentication: JWT/OAuth for HTTP API                              │
│                                                                          │
│ OBSERVABILITY:                                                           │
│   - Metrics: Prometheus-compatible endpoints                             │
│   - Tracing: OpenTelemetry integration                                  │
│   - Logging: JSON logs to stdout (K8s log aggregation)                  │
│   - Events: Session/Event stored in database for audit                  │
│                                                                          │
│ PERFORMANCE:                                                             │
│   - Latency: A2A streaming for low-latency responses                     │
│   - Throughput: Depends on LLM provider rate limits                      │
│   - Tool discovery: Cached in database (configurable sync)               │
│   - Database: Connection pooling, query optimization                     │
│                                                                          │
│ COMPATIBILITY:                                                           │
│   - K8s versions: 1.24+                                                  │
│   - A2A protocol: v0.3.0                                                 │
│   - LLM providers: Multiple (OpenAI, Anthropic, Azure, Gemini, etc.)    │
│   - MCP servers: HTTP/SSE or stdio-based                                │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Using PlantUML

To render the PlantUML diagram, you can:

1. **Online**: Copy the PlantUML code to https://www.plantuml.com/plantuml/uml/
2. **Local**: Use PlantUML CLI: `plantuml kagent-mbse-diagram.puml`
3. **IDE plugins**: Install PlantUML extensions for VS Code, IntelliJ, etc.
4. **Generate images**: `plantuml -tpng kagent-mbse-diagram.puml`

The main diagram file is: `kagent-mbse-diagram.puml`
